name: Security Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  # üìÅ Target directory for security scanning - change this to scan different example apps
  SCAN_TARGET: example_app/terraform-aws-lambda-example

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Step 1: Secrets Detection
    - name: Install TruffleHog
      run: |
        curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

    - name: Run secrets scan
      run: |
        # Run TruffleHog with proper format flags
        trufflehog filesystem ${{ env.SCAN_TARGET }} --json --results=verified,unknown > secrets-results.json || echo "[]" > secrets-results.json
        trufflehog filesystem ${{ env.SCAN_TARGET }} --format=sarif --results=verified,unknown > secrets-results.sarif || echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"TruffleHog","version":"3.0"}},"results":[]}]}' > secrets-results.sarif

    - name: Upload secrets results to Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: secrets-results.sarif
        category: secrets-scan

    # Step 2: IaC Security Scan
    - name: Run Trivy IaC scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'config'
        scan-ref: ${{ env.SCAN_TARGET }}
        format: 'sarif'
        output: 'iac-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM,LOW'

    - name: Run Trivy IaC scan for PR comment
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'config'
        scan-ref: ${{ env.SCAN_TARGET }}
        format: 'table'
        output: 'iac-results.txt'
        severity: 'CRITICAL,HIGH,MEDIUM,LOW'

    - name: Upload IaC results to Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: iac-results.sarif
        category: iac-scan

    # Step 3: Dependency Security Scan
    - name: Run Trivy dependency scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: ${{ env.SCAN_TARGET }}
        format: 'sarif'
        output: 'dependency-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM,LOW'

    - name: Run Trivy dependency scan for PR comment
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: ${{ env.SCAN_TARGET }}
        format: 'table'
        output: 'dependency-results.txt'
        severity: 'CRITICAL,HIGH,MEDIUM,LOW'

    - name: Upload dependency results to Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: dependency-results.sarif
        category: dependency-scan

    # Step 4: Create PR Comment
    - name: Create PR comment
      if: github.event_name == 'pull_request'
      run: |
        # Parse secrets count properly and remove any newlines/duplicates
        SECRETS_COUNT=$(cat secrets-results.json | jq -r 'length // 0' | tr -d '\n' | head -1)
        
        # Extract IaC Report Summary table directly from Trivy output
        IAC_REPORT_SUMMARY=""
        if [ -f iac-results.txt ] && [ -s iac-results.txt ]; then
          # Extract the entire Report Summary table
          IAC_REPORT_SUMMARY=$(awk '/Report Summary/,/Legend:/' iac-results.txt | head -n -1)
        fi
        
        # Count dependency issues more accurately
        DEP_CRITICAL=0
        DEP_HIGH=0
        DEP_MEDIUM=0
        DEP_LOW=0
        
        if [ -f dependency-results.txt ] && [ -s dependency-results.txt ]; then
          # Parse the summary table from Trivy output to get accurate counts
          if grep -q "Total:" dependency-results.txt; then
            SUMMARY_LINE=$(grep "Total:" dependency-results.txt | head -1)
            DEP_LOW=$(echo "$SUMMARY_LINE" | grep -o "LOW: [0-9]*" | grep -o "[0-9]*" || echo "0")
            DEP_MEDIUM=$(echo "$SUMMARY_LINE" | grep -o "MEDIUM: [0-9]*" | grep -o "[0-9]*" || echo "0")
            DEP_HIGH=$(echo "$SUMMARY_LINE" | grep -o "HIGH: [0-9]*" | grep -o "[0-9]*" || echo "0")
            DEP_CRITICAL=$(echo "$SUMMARY_LINE" | grep -o "CRITICAL: [0-9]*" | grep -o "[0-9]*" || echo "0")
          fi
        fi
        
        # Generate secrets summary with robust parsing
        SECRETS_DETAILS=""
        if [ "$SECRETS_COUNT" -gt 0 ]; then
          SECRETS_DETAILS="‚ö†Ô∏è **CRITICAL: Secrets detected!**\n\nFound in:"
          # Try multiple TruffleHog JSON field patterns for compatibility
          if command -v jq >/dev/null 2>&1; then
            # Approach 1: Try modern TruffleHog v3+ structure
            PARSED_SECRETS=$(cat secrets-results.json | jq -r '.[] | 
              if .SourceMetadata.Data.Filesystem then
                "- \(.DetectorName // "Unknown"): \(.SourceMetadata.Data.Filesystem.file):\(.SourceMetadata.Data.Filesystem.line // "?")"
              elif .SourceName then
                "- \(.DetectorName // "Unknown"): \(.SourceName) (line unknown)"
              else
                "- \(.DetectorName // "Unknown detector"): location unknown"
              end' 2>/dev/null)
            
            if [ -n "$PARSED_SECRETS" ] && [ "$PARSED_SECRETS" != "null" ]; then
              SECRETS_DETAILS="$SECRETS_DETAILS\n$PARSED_SECRETS"
            else
              SECRETS_DETAILS="$SECRETS_DETAILS\n- Found $SECRETS_COUNT secrets (check Security tab for details)"
            fi
          else
            SECRETS_DETAILS="$SECRETS_DETAILS\n- Found $SECRETS_COUNT secrets (check Security tab for details)"
          fi
        else
          SECRETS_DETAILS="‚úÖ No secrets detected"
        fi
        
        cat > pr_comment.md << EOF
        ## üõ°Ô∏è Security Scan Results
        
        ### üîê Secrets Detection
        **Secrets Found:** $SECRETS_COUNT
        
        $(echo -e "$SECRETS_DETAILS")
        
        ### üîí IaC Security Issues
        
        \`\`\`
        $IAC_REPORT_SUMMARY
        \`\`\`
        
        ### üì¶ Dependency Vulnerabilities
        | Severity | Count |
        |----------|-------|
        | Critical | $DEP_CRITICAL |
        | High | $DEP_HIGH |
        | Medium | $DEP_MEDIUM |
        | Low | $DEP_LOW |
        
        <details>
        <summary>View IaC Security Details</summary>
        
        \`\`\`
        $(if [ -f iac-results.txt ]; then cat iac-results.txt; else echo "No IaC issues found"; fi)
        \`\`\`
        </details>
        
        <details>
        <summary>View Dependency Details</summary>
        
        \`\`\`
        $(if [ -f dependency-results.txt ]; then cat dependency-results.txt; else echo "No dependency vulnerabilities found"; fi)
        \`\`\`
        </details>
        
        üìã Full results in [Security tab](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/security/code-scanning)
        EOF

    - name: Post PR comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const commentBody = fs.readFileSync('pr_comment.md', 'utf8');
          
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          for (const comment of comments.data) {
            if (comment.body.includes('üõ°Ô∏è Security Scan Results')) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
              });
            }
          }
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: commentBody
          });
